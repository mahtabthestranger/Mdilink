
# Initialize MySQL
mysql = MySQL(app)

# Import models
from models.admin import Admin
from models.doctor import Doctor
from models.patient import Patient
from models.appointment import Appointment
from models.medical_record import MedicalRecord
from models.password_reset import PasswordReset
from models.chatbot import Chatbot

# Import controllers (will be created later)
# from controllers import admin_controller, doctor_controller, patient_controller

@app.route('/')
def index():
    """Home page"""
    return render_template('index.html')

# Chatbot API Route
@app.route('/api/chat', methods=['POST'])
def chat():
    """Handle chatbot messages"""
    try:
        data = request.get_json()
        message = data.get('message', '').strip()
        
        if not message:
            return jsonify({'error': 'Message is required'}), 400
        
        # Get user context
        user_context = None
        if session.get('user_type'):
            user_context = {
                'user_type': session.get('user_type'),
                'user_id': session.get('user_id'),
                'user_name': session.get('user_name', 'User')
            }
        
        # Get chatbot response
        response = Chatbot.get_response(message, user_context)
        
        # Save to database if user is logged in
        if user_context:
            Chatbot.save_message(
                mysql,
                user_context['user_id'],
                user_context['user_type'],
                message,
                response
            )
        
        return jsonify({
            'response': response,
            'timestamp': datetime.now().isoformat()
        })
        
    except Exception as e:
        print(f"Chat error: {e}")
        return jsonify({'error': 'Failed to process message'}), 500

@app.route('/admin/login', methods=['GET', 'POST'])
def admin_login():
    """Admin login page"""
    if request.method == 'POST':
        username = request.form.get('username', '').strip()
        password = request.form.get('password', '')
        
        # Validation
        if not username or not password:
            flash('Please enter username and password', 'error')
            return redirect(url_for('admin_login'))
        
        # Verify credentials
        admin = Admin.verify_password(mysql, username, password)
        
        if admin:
            # Set session
            session['user_type'] = 'admin'
            session['user_id'] = admin['admin_id']
            session['user_name'] = admin['full_name']
            session['username'] = admin['username']
            session.permanent = True
            
            flash(f'Welcome, {admin["full_name"]}!', 'success')
            return redirect(url_for('admin_dashboard'))
        else:
            flash('Invalid username or password', 'error')
            return redirect(url_for('admin_login'))
    
    return render_template('admin/login.html')

@app.route('/doctor/login', methods=['GET', 'POST'])
def doctor_login():
    """Doctor login page"""
    if request.method == 'POST':
        doctor_code = request.form.get('doctor_code', '').strip()
        password = request.form.get('password', '')
        
        # Validation
        if not doctor_code or not password:
            flash('Please enter doctor ID and password', 'error')
            return redirect(url_for('doctor_login'))
        
        # Verify credentials
        doctor = Doctor.verify_password(mysql, doctor_code, password)
        
        if doctor:
            # Check if account is active
            if not doctor.get('is_active', True):
                flash('Access denied. Your account has been deactivated', 'error')
                return redirect(url_for('doctor_login'))
            
            # Set session
            session['user_type'] = 'doctor'
            session['user_id'] = doctor['doctor_id']
            session['user_name'] = doctor['full_name']
            session['doctor_code'] = doctor['doctor_code']
            session.permanent = True
            
            flash(f'Welcome, Dr. {doctor["full_name"]}!', 'success')
            return redirect(url_for('doctor_dashboard'))
        else:
            flash('Invalid credentials', 'error')
            return redirect(url_for('doctor_login'))
    
    return render_template('doctor/login.html')

@app.route('/patient/login', methods=['GET', 'POST'])
def patient_login():
    """Patient login page"""
    if request.method == 'POST':
        email = request.form.get('email', '').strip().lower()
        password = request.form.get('password', '')
        
        # Validation
        if not email or not password:
            flash('Please enter email and password', 'error')
            return redirect(url_for('patient_login'))
        
        # Verify credentials
        patient = Patient.verify_password(mysql, email, password)
        
        if patient:
            # Set session
            session['user_type'] = 'patient'
            session['user_id'] = patient['patient_id']
            session['user_name'] = patient['full_name']
            session['user_email'] = patient['email']
            session.permanent = True
            
            flash(f'Welcome back, {patient["full_name"]}!', 'success')
            return redirect(url_for('patient_dashboard'))
        else:
            flash('Invalid email or password', 'error')
            return redirect(url_for('patient_login'))
    
    return render_template('patient/login.html')

@app.route('/patient/register', methods=['GET', 'POST'])
def patient_register():
    """Patient registration page"""
    if request.method == 'POST':
        # Get form data
        full_name = request.form.get('full_name', '').strip()
        age = request.form.get('age', '').strip()
        gender = request.form.get('gender', '').strip()
        phone = request.form.get('phone', '').strip()
        email = request.form.get('email', '').strip().lower()
        password = request.form.get('password', '')
        confirm_password = request.form.get('confirm_password', '')
        address = request.form.get('address', '').strip()
        blood_group = request.form.get('blood_group', '').strip()
        emergency_contact = request.form.get('emergency_contact', '').strip()
        
        # Validation
        if not all([full_name, age, gender, phone, email, password]):
            flash('Please fill all required fields', 'error')
            return redirect(url_for('patient_register'))
        
        # Password confirmation
        if password != confirm_password:
            flash('Passwords do not match', 'error')
            return redirect(url_for('patient_register'))
        
        # Password length check
        if len(password) < 6:
            flash('Password must be at least 6 characters long', 'error')
            return redirect(url_for('patient_register'))
        
        # Age validation
        try:
            age = int(age)
            if age < 1 or age > 150:
                flash('Please enter a valid age', 'error')
                return redirect(url_for('patient_register'))
        except ValueError:
            flash('Please enter a valid age', 'error')
            return redirect(url_for('patient_register'))
        
        # Check if email already exists
        if Patient.email_exists(mysql, email):
            flash('User already registered with this email', 'error')
            return redirect(url_for('patient_register'))
        
        try:
            # Create patient account
            patient_id = Patient.create(
                mysql=mysql,
                full_name=full_name,
                age=age,
                gender=gender,
                phone=phone,
                email=email,
                password=password,
                address=address if address else None,
                blood_group=blood_group if blood_group else None,
                emergency_contact=emergency_contact if emergency_contact else None
            )
            
            flash('Registration successful! Please login to continue', 'success')
            return redirect(url_for('patient_login'))
            
        except Exception as e:
            flash('Registration failed. Please try again', 'error')
            print(f"Registration error: {e}")  # For debugging
            return redirect(url_for('patient_register'))
    
    return render_template('patient/register.html')

# Password Reset Routes
@app.route('/forgot-password', methods=['GET', 'POST'])
def forgot_password():
    """Forgot password page"""
    if request.method == 'POST':
        email = request.form.get('email', '').strip().lower()
        user_type = request.form.get('user_type', '').strip()
        
        if not email or not user_type:
            flash('Please enter your email and select user type', 'error')
            return redirect(url_for('forgot_password'))
        
        # Find user by email
        user = PasswordReset.find_user_by_email(mysql, email, user_type)
        
        if user:
            # Generate reset token
            token = PasswordReset.create_token(mysql, user_type, user['user_id'], email)
            
            # In production, send email with reset link
            # For development, display the link
            reset_link = url_for('reset_password', token=token, _external=True)
            print(f"\n{'='*60}")
            print(f"PASSWORD RESET LINK FOR {user['full_name']} ({email}):")
            print(f"{reset_link}")
            print(f"{'='*60}\n")
            
            flash('Password reset link has been generated. Check the console for the link.', 'success')
        else:
            # Don't reveal if email exists or not (security best practice)
            flash('If an account exists with that email, a reset link has been sent.', 'info')
        
        return redirect(url_for('forgot_password'))
    
    return render_template('forgot_password.html')

@app.route('/reset-password/<token>', methods=['GET', 'POST'])
def reset_password(token):
    """Reset password with token"""
    # Verify token
    token_data = PasswordReset.verify_token(mysql, token)
    
    if not token_data:
        flash('Invalid or expired reset link', 'error')
        return redirect(url_for('forgot_password'))
    
    if request.method == 'POST':
        password = request.form.get('password', '')
        confirm_password = request.form.get('confirm_password', '')
        
        # Validation
        if not password or not confirm_password:
            flash('Please enter and confirm your password', 'error')
            return redirect(url_for('reset_password', token=token))
        
        if password != confirm_password:
            flash('Passwords do not match', 'error')
            return redirect(url_for('reset_password', token=token))
        
        if len(password) < 6:
            flash('Password must be at least 6 characters long', 'error')
            return redirect(url_for('reset_password', token=token))
        
        try:
            # Update password based on user type
            from werkzeug.security import generate_password_hash
            hashed_password = generate_password_hash(password)
            
            cursor = mysql.connection.cursor()
            
            if token_data['user_type'] == 'patient':
                cursor.execute("""
                    UPDATE patients SET password = %s WHERE patient_id = %s
                """, (hashed_password, token_data['user_id']))
            elif token_data['user_type'] == 'doctor':
                cursor.execute("""
                    UPDATE doctors SET password = %s WHERE doctor_id = %s
                """, (hashed_password, token_data['user_id']))
            elif token_data['user_type'] == 'admin':
                cursor.execute("""
                    UPDATE admins SET password = %s WHERE admin_id = %s
                """, (hashed_password, token_data['user_id']))
            
            mysql.connection.commit()
            cursor.close()
            
            # Delete the used token
            PasswordReset.delete_token(mysql, token)
            
            flash('Password reset successful! Please login with your new password.', 'success')
            
            # Redirect to appropriate login page
            if token_data['user_type'] == 'patient':
                return redirect(url_for('patient_login'))
            elif token_data['user_type'] == 'doctor':
                return redirect(url_for('doctor_login'))
            else:
                return redirect(url_for('admin_login'))
                
        except Exception as e:
            flash('Failed to reset password. Please try again.', 'error')
            print(f"Password reset error: {e}")
            return redirect(url_for('reset_password', token=token))
    
    return render_template('reset_password.html', token=token, email=token_data['email'])

# Logout route
@app.route('/logout')
def logout():
    """Logout user"""
    user_type = session.get('user_type')
    session.clear()
    flash('You have been logged out successfully', 'success')
    
    # Redirect to appropriate login page
    if user_type == 'admin':
        return redirect(url_for('admin_login'))
    elif user_type == 'doctor':
        return redirect(url_for('doctor_login'))
    else:
        return redirect(url_for('patient_login'))

# Dashboard routes
@app.route('/admin/dashboard')
def admin_dashboard():
    """Admin dashboard"""
    if session.get('user_type') != 'admin':
        flash('Please login to access admin dashboard', 'error')
        return redirect(url_for('admin_login'))
    
    # Fetch statistics
    cursor = mysql.connection.cursor()
    
    # Count doctors
    cursor.execute("SELECT COUNT(*) as count FROM doctors WHERE is_active = TRUE")
    doctor_count = cursor.fetchone()['count']
    
    # Count patients
    cursor.execute("SELECT COUNT(*) as count FROM patients WHERE is_active = TRUE")
    patient_count = cursor.fetchone()['count']
    
    # Count appointments
    cursor.execute("SELECT COUNT(*) as count FROM appointments")
    appointment_count = cursor.fetchone()['count']
    
    # Count medical records
    cursor.execute("SELECT COUNT(*) as count FROM medical_records")
    record_count = cursor.fetchone()['count']
    
    cursor.close()
    
    return render_template('admin/dashboard.html', 
                         doctor_count=doctor_count,
                         patient_count=patient_count,
                         appointment_count=appointment_count,
                         record_count=record_count)

@app.route('/doctor/dashboard')
def doctor_dashboard():
    """Doctor dashboard"""
    if session.get('user_type') != 'doctor':
        flash('Please login to access doctor dashboard', 'error')
        return redirect(url_for('doctor_login'))
    return render_template('doctor/dashboard.html')

@app.route('/doctor/appointments')
def doctor_appointments():
    """View doctor appointments"""
    if session.get('user_type') != 'doctor':
        flash('Please login to access doctor dashboard', 'error')
        return redirect(url_for('doctor_login'))
    
    # Get filters
    date_filter = request.args.get('date')
    status_filter = request.args.get('status')
    
    appointments = Appointment.get_by_doctor(mysql, session.get('user_id'), date_filter, status_filter)
    
    from datetime import date
    return render_template('doctor/appointments.html', 
                         appointments=appointments,
                         today_date=date.today().strftime('%Y-%m-%d'),
                         current_date=date_filter,
                         current_status=status_filter)

@app.route('/doctor/appointment/<int:appointment_id>/status', methods=['POST'])
def doctor_update_appointment_status(appointment_id):
    """Update appointment status"""
    if session.get('user_type') != 'doctor':
        flash('Please login to access doctor dashboard', 'error')
        return redirect(url_for('doctor_login'))
    
    status = request.form.get('status')
    if status not in ['Completed', 'Cancelled']:
        flash('Invalid status', 'error')
        return redirect(url_for('doctor_appointments'))
    
    try:
        # Verify appointment belongs to doctor
        appointment = Appointment.find_by_id(mysql, appointment_id)
        if not appointment or appointment['doctor_id'] != session.get('user_id'):
            flash('Appointment not found or access denied', 'error')
            return redirect(url_for('doctor_appointments'))
        
        Appointment.update_status(mysql, appointment_id, status)
        flash(f'Appointment marked as {status}', 'success')
        
    except Exception as e:
        flash('Failed to update status', 'error')
        print(f"Error updating status: {e}")
        
    return redirect(url_for('doctor_appointments'))

@app.route('/doctor/patients')
def doctor_patients():
    """List all patients for doctor"""
    if session.get('user_type') != 'doctor':
        flash('Please login to access doctor dashboard', 'error')
        return redirect(url_for('doctor_login'))
    
    # In a real app, we might want to filter patients who have appointments with this doctor
    # For now, we'll list all patients to allow the doctor to find any patient
        flash('Patient not found', 'error')
        return redirect(url_for('doctor_patients'))
    
    # Get medical history
    records = MedicalRecord.get_by_patient(mysql, patient_id)
    
    return render_template('doctor/patient_details.html', patient=patient, records=records)

@app.route('/doctor/patient/<int:patient_id>/add-record', methods=['GET', 'POST'])
def doctor_add_record(patient_id):
    """Add new medical record"""
    if session.get('user_type') != 'doctor':
        flash('Please login to access doctor dashboard', 'error')
        return redirect(url_for('doctor_login'))
    
    patient = Patient.find_by_id(mysql, patient_id)
    if not patient:
        flash('Patient not found', 'error')
        return redirect(url_for('doctor_patients'))
    
    if request.method == 'POST':
        diagnosis = request.form.get('diagnosis', '').strip()
        symptoms = request.form.get('symptoms', '').strip()
        prescription = request.form.get('prescription', '').strip()
        tests_recommended = request.form.get('tests_recommended', '').strip()
        notes = request.form.get('notes', '').strip()
        follow_up_date = request.form.get('follow_up_date')
        
        if not diagnosis:
            flash('Diagnosis is required', 'error')
            return redirect(url_for('doctor_add_record', patient_id=patient_id))
        
        try:
            from datetime import date
            MedicalRecord.create(
                mysql=mysql,
                patient_id=patient_id,
                doctor_id=session.get('user_id'),
                visit_date=date.today(),
                diagnosis=diagnosis,
                symptoms=symptoms if symptoms else None,
                prescription=prescription if prescription else None,
                tests_recommended=tests_recommended if tests_recommended else None,
                notes=notes if notes else None,
                follow_up_date=follow_up_date if follow_up_date else None
            )
            
            flash('Medical record added successfully', 'success')
            return redirect(url_for('doctor_view_patient', patient_id=patient_id))
            
        except Exception as e:
            flash('Failed to add medical record', 'error')
            print(f"Error adding record: {e}")
            return redirect(url_for('doctor_add_record', patient_id=patient_id))
    
    return render_template('doctor/add_record.html', patient=patient)

@app.route('/doctor/record/<int:record_id>/edit', methods=['GET', 'POST'])
def doctor_edit_record(record_id):
    """Edit medical record"""
    if session.get('user_type') != 'doctor':
        flash('Please login to access doctor dashboard', 'error')
        return redirect(url_for('doctor_login'))
    
    record = MedicalRecord.find_by_id(mysql, record_id)
    if not record:
        flash('Record not found', 'error')
        return redirect(url_for('doctor_patients'))
    
    # Check if this doctor created the record
    if record['doctor_id'] != session.get('user_id'):
        flash('You can only edit records created by you', 'error')
        return redirect(url_for('doctor_view_patient', patient_id=record['patient_id']))
    
    if request.method == 'POST':
        diagnosis = request.form.get('diagnosis', '').strip()
        symptoms = request.form.get('symptoms', '').strip()
        prescription = request.form.get('prescription', '').strip()
        tests_recommended = request.form.get('tests_recommended', '').strip()
        notes = request.form.get('notes', '').strip()
        follow_up_date = request.form.get('follow_up_date')
        
        if not diagnosis:
            flash('Diagnosis is required', 'error')
            return redirect(url_for('doctor_edit_record', record_id=record_id))
        
        try:
            MedicalRecord.update(
                mysql=mysql,
                record_id=record_id,
                diagnosis=diagnosis,
                symptoms=symptoms if symptoms else None,
                prescription=prescription if prescription else None,
                tests_recommended=tests_recommended if tests_recommended else None,
                notes=notes if notes else None,
                follow_up_date=follow_up_date if follow_up_date else None
            )
            
            flash('Medical record updated successfully', 'success')
            return redirect(url_for('doctor_view_patient', patient_id=record['patient_id']))
            
        except Exception as e:
            flash('Failed to update medical record', 'error')
            print(f"Error updating record: {e}")
            return redirect(url_for('doctor_edit_record', record_id=record_id))
            
    return render_template('doctor/edit_record.html', record=record)

@app.route('/patient/dashboard')
def patient_dashboard():
    """Patient dashboard"""
    if session.get('user_type') != 'patient':
        flash('Please login to access patient dashboard', 'error')
        return redirect(url_for('patient_login'))
    return render_template('patient/dashboard.html')

@app.route('/patient/book-appointment', methods=['GET', 'POST'])
def patient_book_appointment():
    """Book an appointment"""
    if session.get('user_type') != 'patient':
        flash('Please login to book an appointment', 'error')
        return redirect(url_for('patient_login'))
    
    if request.method == 'POST':
        doctor_id = request.form.get('doctor_id')
        appointment_date = request.form.get('appointment_date')
        appointment_time = request.form.get('appointment_time')
        reason = request.form.get('reason', '').strip()
        
        # Validation
        if not all([doctor_id, appointment_date, appointment_time]):
            flash('Please fill all required fields', 'error')
            return redirect(url_for('patient_book_appointment'))
        
        # Check availability
        if not Appointment.check_availability(mysql, doctor_id, appointment_date, appointment_time):
            flash('This time slot is already booked. Please choose another time.', 'error')
            return redirect(url_for('patient_book_appointment'))
        
        try:
            # Create appointment
            Appointment.create(
                mysql=mysql,
                patient_id=session.get('user_id'),
                doctor_id=doctor_id,
                appointment_date=appointment_date,
                appointment_time=appointment_time,
                reason=reason
            )
            
            flash('Appointment booked successfully!', 'success')
            return redirect(url_for('patient_dashboard'))
            
        except Exception as e:
            flash('Failed to book appointment. Please try again', 'error')
            print(f"Booking error: {e}")
            return redirect(url_for('patient_book_appointment'))
    
    # GET request: Show form
    from datetime import date
    doctors = Doctor.get_all(mysql)
    return render_template('patient/book_appointment.html', 
                         doctors=doctors, 
                         today_date=date.today().strftime('%Y-%m-%d'))

@app.route('/patient/appointments')
def patient_appointments():
    """View patient appointments"""
    if session.get('user_type') != 'patient':
        flash('Please login to view appointments', 'error')
        return redirect(url_for('patient_login'))
    
    appointments = Appointment.get_by_patient(mysql, session.get('user_id'))
    return render_template('patient/appointments.html', appointments=appointments)

@app.route('/patient/appointment/<int:appointment_id>/cancel', methods=['POST'])
def patient_cancel_appointment(appointment_id):
    """Cancel patient appointment"""
    if session.get('user_type') != 'patient':
        flash('Please login to cancel appointments', 'error')
        return redirect(url_for('patient_login'))
    
    try:
        # Verify appointment belongs to patient
        appointment = Appointment.find_by_id(mysql, appointment_id)
        if not appointment or appointment['patient_id'] != session.get('user_id'):
            flash('Appointment not found or access denied', 'error')
            return redirect(url_for('patient_appointments'))
        
        # Check if appointment is already cancelled or completed
        if appointment['status'] != 'Scheduled':
            flash('Only scheduled appointments can be cancelled', 'error')
            return redirect(url_for('patient_appointments'))
        
        Appointment.update_status(mysql, appointment_id, 'Cancelled')
        flash('Appointment cancelled successfully', 'success')
        
    except Exception as e:
        flash('Failed to cancel appointment', 'error')
        print(f"Error cancelling appointment: {e}")
        
    return redirect(url_for('patient_appointments'))

@app.route('/patient/medical-records')
def patient_medical_records():
    """View patient medical records"""
    if session.get('user_type') != 'patient':
        flash('Please login to view medical records', 'error')
        return redirect(url_for('patient_login'))
    
    records = MedicalRecord.get_by_patient(mysql, session.get('user_id'))
    return render_template('patient/medical_records.html', records=records)

# Doctor Management Routes (Admin only)
@app.route('/admin/doctors')
def admin_doctors():
    """List all doctors"""
    if session.get('user_type') != 'admin':
        flash('Please login as admin', 'error')
        return redirect(url_for('admin_login'))
    
    doctors = Doctor.get_all(mysql)
    return render_template('admin/doctors.html', doctors=doctors)

@app.route('/admin/doctors/add', methods=['GET', 'POST'])
def admin_add_doctor():
    """Add new doctor"""
    if session.get('user_type') != 'admin':
        flash('Please login as admin', 'error')
        return redirect(url_for('admin_login'))
    
    if request.method == 'POST':
        # Get form data
        doctor_code = request.form.get('doctor_code', '').strip()
        full_name = request.form.get('full_name', '').strip()
        university = request.form.get('university', '').strip()
        specialization = request.form.get('specialization', '').strip()
        qualification = request.form.get('qualification', '').strip()
        email = request.form.get('email', '').strip().lower()
        phone = request.form.get('phone', '').strip()
        address = request.form.get('address', '').strip()
        password = request.form.get('password', '')
        
        # Validation
        if not all([doctor_code, full_name, university, email, phone, password]):
            flash('Please fill all required fields', 'error')
            return redirect(url_for('admin_add_doctor'))
        
        # Check if doctor code already exists
        if Doctor.find_by_code(mysql, doctor_code):
            flash('Doctor ID already exists', 'error')
            return redirect(url_for('admin_add_doctor'))
        
        try:
            # Create doctor
            doctor_id = Doctor.create(
                mysql=mysql,
                doctor_code=doctor_code,
                password=password,
                full_name=full_name,
                university=university,
                email=email,
                phone=phone,
                specialization=specialization if specialization else None,
                qualification=qualification if qualification else None,
                address=address if address else None,
                created_by=session.get('user_id')
            )
            
            flash(f'Doctor {full_name} added successfully!', 'success')
            return redirect(url_for('admin_doctors'))
            
        except Exception as e:
            flash('Failed to add doctor. Please try again', 'error')
            print(f"Error adding doctor: {e}")
            return redirect(url_for('admin_add_doctor'))
    
    return render_template('admin/add_doctor.html')

@app.route('/admin/doctors/edit/<int:doctor_id>', methods=['GET', 'POST'])
def admin_edit_doctor(doctor_id):
    """Edit doctor details"""
    if session.get('user_type') != 'admin':
        flash('Please login as admin', 'error')
        return redirect(url_for('admin_login'))
    
    doctor = Doctor.find_by_id(mysql, doctor_id)
    if not doctor:
        flash('Doctor not found', 'error')
        return redirect(url_for('admin_doctors'))
    
    if request.method == 'POST':
        # Get form data
        full_name = request.form.get('full_name', '').strip()
        university = request.form.get('university', '').strip()
        specialization = request.form.get('specialization', '').strip()
        qualification = request.form.get('qualification', '').strip()
        email = request.form.get('email', '').strip().lower()
        phone = request.form.get('phone', '').strip()
        address = request.form.get('address', '').strip()
        password = request.form.get('password', '')
        
        # Validation
        if not all([full_name, university, email, phone]):
            flash('Please fill all required fields', 'error')
            return redirect(url_for('admin_edit_doctor', doctor_id=doctor_id))
        
        try:
            # Update doctor
            update_data = {
                'full_name': full_name,
                'university': university,
                'email': email,
                'phone': phone,
                'specialization': specialization if specialization else None,
                'qualification': qualification if qualification else None,
                'address': address if address else None
            }
            
            # Only update password if provided
            if password:
                update_data['password'] = password
            
            Doctor.update(mysql, doctor_id, **update_data)
            
            flash(f'Doctor {full_name} updated successfully!', 'success')
            return redirect(url_for('admin_doctors'))
            
        except Exception as e:
            flash('Failed to update doctor. Please try again', 'error')
            print(f"Error updating doctor: {e}")
            return redirect(url_for('admin_edit_doctor', doctor_id=doctor_id))
    
    return render_template('admin/edit_doctor.html', doctor=doctor)

@app.route('/admin/doctors/delete/<int:doctor_id>', methods=['POST'])
def admin_delete_doctor(doctor_id):
    """Delete (deactivate) doctor"""
    if session.get('user_type') != 'admin':
        flash('Please login as admin', 'error')
        return redirect(url_for('admin_login'))
    
    doctor = Doctor.find_by_id(mysql, doctor_id)
    if not doctor:
        flash('Doctor not found', 'error')
        return redirect(url_for('admin_doctors'))
    
    try:
        Doctor.delete(mysql, doctor_id)
        flash(f'Doctor {doctor["full_name"]} deleted successfully', 'success')
    except Exception as e:
        flash('Failed to delete doctor', 'error')
        print(f"Error deleting doctor: {e}")
    
    return redirect(url_for('admin_doctors'))

@app.route('/admin/patients')
def admin_patients():
    """List all patients"""
    if session.get('user_type') != 'admin':
        flash('Please login as admin', 'error')
        return redirect(url_for('admin_login'))
    
    patients = Patient.get_all(mysql)
    return render_template('admin/patients.html', patients=patients)

@app.route('/admin/patients/edit/<int:patient_id>', methods=['GET', 'POST'])
def admin_edit_patient(patient_id):
    """Edit patient details"""
    if session.get('user_type') != 'admin':
        flash('Please login as admin', 'error')
        return redirect(url_for('admin_login'))
    
    patient = Patient.find_by_id(mysql, patient_id)
    if not patient:
        flash('Patient not found', 'error')
        return redirect(url_for('admin_patients'))
    
    if request.method == 'POST':
        # Get form data
        full_name = request.form.get('full_name', '').strip()
        age = request.form.get('age', '').strip()
        gender = request.form.get('gender', '').strip()
        phone = request.form.get('phone', '').strip()
        email = request.form.get('email', '').strip().lower()
        address = request.form.get('address', '').strip()
        blood_group = request.form.get('blood_group', '').strip()
        emergency_contact = request.form.get('emergency_contact', '').strip()
        
        # Validation
        if not all([full_name, age, gender, phone, email]):
            flash('Please fill all required fields', 'error')
            return redirect(url_for('admin_edit_patient', patient_id=patient_id))
        
        try:
            # Update patient
            Patient.update(
                mysql=mysql,
                patient_id=patient_id,
                full_name=full_name,
                age=age,
                gender=gender,
                phone=phone,
                email=email,
                address=address if address else None,
                blood_group=blood_group if blood_group else None,
                emergency_contact=emergency_contact if emergency_contact else None
            )
            
            flash(f'Patient {full_name} updated successfully!', 'success')
            return redirect(url_for('admin_patients'))
            
        except Exception as e:
            flash('Failed to update patient. Please try again', 'error')
            print(f"Error updating patient: {e}")
            return redirect(url_for('admin_edit_patient', patient_id=patient_id))
    
    return render_template('admin/edit_patient.html', patient=patient)

@app.route('/admin/patients/delete/<int:patient_id>', methods=['POST'])
def admin_delete_patient(patient_id):
    """Delete (deactivate) patient"""
    if session.get('user_type') != 'admin':
        flash('Please login as admin', 'error')
        return redirect(url_for('admin_login'))
    
    patient = Patient.find_by_id(mysql, patient_id)
    if not patient:
        flash('Patient not found', 'error')
        return redirect(url_for('admin_patients'))
    
    try:
        Patient.delete(mysql, patient_id)
        flash(f'Patient {patient["full_name"]} deleted successfully', 'success')
    except Exception as e:
        flash('Failed to delete patient', 'error')
        print(f"Error deleting patient: {e}")
    
    return redirect(url_for('admin_patients'))

# Error handlers
@app.errorhandler(404)
def not_found(error):
    """404 error handler"""
    return render_template('errors/404.html'), 404

@app.errorhandler(500)
def internal_error(error):
    """500 error handler"""
    return render_template('errors/500.html'), 500

# Context processor for session data
@app.context_processor
def inject_user():
    """Inject user data into all templates"""
    return dict(
        user_type=session.get('user_type'),
        user_id=session.get('user_id'),
        user_name=session.get('user_name')
    )

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
